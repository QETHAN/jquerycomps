(function(b){window.Suggest=JC.Suggest=a;function a(e){e&&(e=b(e));if(!e||a.getInstance(e)){return}a.getInstance(e,this);this._model=new d(e);this._view=new c(this._model);this._init()}a.prototype={_init:function(){var e=this;this._initHanlderEvent();e._view.init();e._model.init();this._initActionEvent();e.trigger("SuggestInited");return e},update:function(f,g){var e=this;typeof g=="undefined"&&(g=f);if(e._model.sugdatafilter()){g=e._model.sugdatafilter().call(this,g)}if(g&&g.q){e._model.cache(g.q,g)}this._view.update(g)},show:function(){this._view.show();return this},hide:function(){this._view.hide();return this},selector:function(){return this._model.selector()},layout:function(){return this._model.layout()},on:function(f,e){b(this).on(f,e);return this},trigger:function(f,e){b(this).trigger(f,e);return this},_initHanlderEvent:function(){var e=this;b(e._view).on("BindEvent",function(f,h,g){e.on(h,g)});b(e._view).on("TriggerEvent",function(f,h,g){e.trigger(h,[g])});b(e._model).on("BindEvent",function(f,h,g){e.on(h,g)});b(e._model).on("TriggerEvent",function(f,h,g){e.trigger(h,g)})},_initActionEvent:function(){var e=this;e.on("SuggestUpdate",e.update);e.on("SuggestInited",function(f){if(e._model.suginitedcallback()){e._model.suginitedcallback().call(e)}});e._model.selector().on("keyup",function(g){var f=b(this),i=f.val().trim(),h=g.keyCode;JC.log("keyup",i,new Date().getTime(),h);if(h){switch(h){case 38:case 40:g.preventDefault();case 37:case 39:return;case 27:e.hide();return}}if(!i){e.update();return}if(!e._model.layout().is(":visible")){if(e._model.cache(i)){e.update(e._model.cache(i));return}}if(e._model.preValue===i){return}e._model.preValue=i;if(e._model.cache(i)){e.update(e._model.cache(i));return}JC.log(i);if(e._model.queryinterval()){if(e._model.timeout){clearTimeout(e._model.timeout)}e._model.timeout=setTimeout(function(){e._model.getData(i)},e._model.queryinterval())}else{e._model.getData(i)}});e._model.selector().on("keydown",function(f){var j=f.keyCode,k,h,i=e._model.items(),g;j==38&&(h=true);switch(j){case 38:case 40:k=e._model.nextIndex(h);if(k>=0&&k<i.length){f.preventDefault();g=b(i[k]);e._model.selectedIdentifier(g);e.selector().val(e._model.getKeyword(g));return}break}});b(e._model.layout()).delegate(".js_sugItem","mouseenter",function(f){e._model.selectedIdentifier(b(this),true)});b(e._model.layout()).delegate(".js_sugItem","mouseleave",function(f){b(this).removeClass("active")});e.selector().on("click",function(f){f.stopPropagation();e.selector().trigger("keyup")});b(e._model.layout()).delegate(".js_sugItem","click",function(g){var f=b(this),h=e._model.getKeyword(f);e.selector().val(h);e.hide();e.trigger("SuggestSelected",[f]);e._model.sugselectedcallback()&&e._model.sugselectedcallback().call(e,h)})}};a.getInstance=function(e,f){if(typeof e=="string"&&!/</.test(e)){e=b(e)}if(!(e&&e.length)||(typeof e=="string")){return}typeof f!="undefined"&&e.data("SuggestInstace",f);return e.data("SuggestInstace")};a.isSuggest=function(e){var f;e&&(e=b(e)).length&&(f=e.is("[suglayout]"));return f};a.autoInit=true;a.layoutTpl="";a.dataFilter;function d(e){this._selector=e;this._id="Suggest_"+new Date().getTime()}d.prototype={init:function(){return this},selector:function(){return this._selector},layoutTpl:'<dl class="sug_layout js_sugLayout" style="display:none;"></dl>',layout:function(){!this._layout&&this.selector().is("[suglayout]")&&(this._layout=b(this.selector().attr("suglayout")));!this._layout&&(this._layout=b(a.layoutTpl()||this.layoutTpl));!this._layout.hasClass("js_sugLayout")&&this._layout.addClass("js_sugLayout");if(this.sugwidth()){this._layout.css({width:this.sugwidth()+"px"})}return this._layout},sugwidth:function(){this.selector().is("[sugwidth]")&&(this._sugwidth=parseInt(this.selector().attr("sugwidth")));return this._sugwidth},sugoffsetleft:function(){this.selector().is("[sugoffsetleft]")&&(this._sugoffsetleft=parseInt(this.selector().attr("sugoffsetleft")));!this._sugoffsetleft&&(this._sugoffsetleft=0);return this._sugoffsetleft},sugoffsettop:function(){this.selector().is("[sugoffsettop]")&&(this._sugoffsettop=parseInt(this.selector().attr("sugoffsettop")));!this._sugoffsettop&&(this._sugoffsettop=0);return this._sugoffsettop},sugsidepadding:function(){this.selector().is("[sugsidepadding]")&&(this._sugsidepadding=parseInt(this.selector().attr("sugsidepadding")));!this._sugsidepadding&&(this._sugsidepadding=0);return this._sugsidepadding},_dataCallback:function(e){b(this).trigger("TriggerEvent",["SuggestUpdate",e])},sugdatacallback:function(){var e=this;this.selector().is("[sugdatacallback]")&&(this._sugdatacallback=this.selector().attr("sugdatacallback"));!this._sugdatacallback&&(this._sugdatacallback="SuggestDataCallback");!window[this._sugdatacallback]&&(window[this._sugdatacallback]=function(f){e._dataCallback(f)});return this._sugdatacallback},sugurl:function(e){this.selector().is("[sugurl]")&&(this._sugurl=this.selector().attr("sugurl"));!this.selector().is("[sugurl]")&&(this._sugurl="?word={0}&callback={1}");this._sugurl=printf(this._sugurl,e,this.sugdatacallback());return this._sugurl},sugneedscripttag:function(){this._sugneedscripttag=true;this.selector().is("[sugneedscripttag]")&&(this._sugneedscripttag=parseBool(this.selector().attr("sugneedscripttag")));return this._sugneedscripttag},getData:function(i){var f=this,g=this.sugurl(i),h,e="script_"+f._id;JC.log(g,new Date().getTime());if(this.sugneedscripttag()){b("#"+e).remove();h=printf('<script id="{1}" src="{0}"><\/script>',g,e);b(h).appendTo(document.body)}else{b.get(g,function(j){j=b.parseJSON(j);f._dataCallback(j)})}},cache:function(e,f){this._cache=this._cache||{};typeof f!="undefined"&&(this._cache[e]=f);return this._cache[e]},sugselectedcallback:function(){var e=this;this.selector().is("[sugselectedcallback]")&&(this._sugselectedcallback=this.selector().attr("sugselectedcallback"));return this._sugselectedcallback?window[this._sugselectedcallback]:null},suginitedcallback:function(){var e=this;this.selector().is("[suginitedcallback]")&&(this._suginitedcallback=this.selector().attr("suginitedcallback"));return this._suginitedcallback?window[this._suginitedcallback]:null},sugdatafilter:function(){var e=this;this.selector().is("[sugdatafilter]")&&(this._sugdatafilter=this.selector().attr("sugdatafilter"));this._sugdatafilter=this._sugdatafilter||a.dataFilter;return this._sugdatafilter?window[this._dataCallback]:null},queryinterval:function(){this.selector().is("[queryinterval]")&&(this._queryinterval=parseInt(this.selector().attr("queryinterval")));this._queryinterval=this._queryinterval||200;return this._queryinterval},timeout:null,preValue:null,keyindex:-1,nextIndex:function(f){var g=this.items(),e=g.length;if(f){if(this.keyindex<=0){this.keyindex=e-1}else{this.keyindex--}}else{if(this.keyindex>=e-1){this.keyindex=0}else{this.keyindex++}}return this.keyindex},items:function(){return this.layout().find(".js_sugItem")},selectedIdentifier:function(f,e){this._preSelected&&this._preSelected.removeClass("active");f.addClass("active");e&&(this.keyindex=parseInt(f.attr("keyindex")));this._preSelected=f},getKeyword:function(e){var g=e.attr("keyword");try{g=decodeURIComponent(g)}catch(f){}return g},currentData:function(e){typeof e!="undefined"&&(this._currentData=e);return this._currentData}};function c(e){this._model=e}c.prototype={init:function(){return this},show:function(){b(this).trigger("TriggerEvent",["SuggestBeforeShow"]);this._model.layout().show();b(this).trigger("TriggerEvent",["SuggestShow"])},hide:function(){this._model.layout().hide();this.reset();b(this).trigger("TriggerEvent",["SuggestHide"])},update:function(l){var e=this,m=[],f,k,n;if(!(l&&l.s&&l.s.length)){e.hide();return}for(var h=0,g=l.s.length;h<g;h++){k=l.s[h],n=k,f=l.q||"";if(k.indexOf(f)>-1){n=n.slice(f.length);n="<b>"+n+"</b>"}else{f=""}m.push(printf('<dd keyword="{2}" keyindex="{3}" class="js_sugItem">{0}{1}</dd>',f,n,encodeURIComponent(k),h))}e._model.layout().html(m.join(""));JC.log("suggest update");this.reset();e._model.currentData(l);b(this).trigger("TriggerEvent",["SuggestUpdated"]);e.show()},reset:function(){JC.log("suggest reset");this._model.keyindex=-1;this._model.layout().find(".js_sugItem").removeClass("active");b(this).trigger("TriggerEvent",["SuggestReset"])}};b(document).delegate("input[type=text]","focus",function(f){var e=b(this),g=a.getInstance(e);if(g||!a.isSuggest(e)||!a.autoInit){return}JC.log("Suggest input fined:",e.attr("name"),new Date().getTime());g=new a(e)});b(document).on("click",function(e){b("dl.js_sugLayout, div.js_sugLayout").hide()})}(jQuery));